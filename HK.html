<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한국경제 신문 지면보기</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Firebase SDK (순서 중요: app → firestore → auth) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <!-- PhotoSwipe CSS -->
    <link rel="stylesheet" href="https://unpkg.com/photoswipe@5.4.3/dist/photoswipe.css">
    
    <!-- 사용자 정의 CSS -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">       
        <div class="controls card p-4">
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">날짜</label>
                    <input type="date" class="form-control" id="date-picker">
                </div>
                <div class="col-md-3">
                    <label class="form-label">신문 타입</label>
                    <select class="form-select" id="type-select">
                        <option value="A" selected>A (종합)</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">페이지 (예: A001)</label>
                    <input type="text" class="form-control" id="face-input" value="A001" placeholder="A001">
                </div>
                <div class="col-md-2">
                    <button class="btn btn-primary w-100" id="go-btn">이동</button>
                </div>
            </div>
            
            <div class="mt-3 text-center">
                <button class="btn btn-outline-secondary me-2" id="prev-btn">◀ 이전</button>
                <button class="btn btn-outline-secondary" id="next-btn">다음 ▶</button>
            </div>
        </div>
        
        <div id="viewer">
            <p id="page-info" class="text-muted"></p>
            
            <div class="text-center mb-4">
                <button class="btn btn-outline-primary me-2" id="single-mode-btn">단일 페이지 보기</button>
                <button class="btn btn-primary" id="double-mode-btn">두 쪽 보기</button>
            </div>
            
            <!-- 단일 보기 -->
            <div id="single-view">
                <div class="image-click-area" style="position: relative; display: inline-block; max-width: 100%;">
                    <img id="newspaper-img" src="" alt="신문 페이지 로딩 중..." loading="lazy" class="newspaper-img img-fluid">
                    
                    <div class="click-left"></div>
                    <div class="click-right"></div>
                </div>
            </div>
            
            <!-- 두 쪽 보기 -->
            <div id="double-view" style="display: none;">
                <div class="row justify-content-center">
                    <div class="col-6 text-end">
                        <p class="text-muted mb-2">오른쪽 (홀수면)</p>
                        <div class="image-click-area" style="position: relative; display: inline-block; max-width: 100%;">
                            <img id="right-img" src="" alt="오른쪽 페이지" loading="lazy" class="newspaper-img img-fluid">
                            <div class="click-left"></div>
                            <div class="click-right"></div>
                        </div>
                    </div>
                    <div class="col-6 text-start">
                        <p class="text-muted mb-2">왼쪽 (짝수면)</p>
                        <div class="image-click-area" style="position: relative; display: inline-block; max-width: 100%;">
                            <img id="left-img" src="" alt="왼쪽 페이지" loading="lazy" class="newspaper-img img-fluid">
                            <div class="click-left"></div>
                            <div class="click-right"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <p id="error-msg">해당 페이지 이미지가 존재하지 않거나 접근이 제한됩니다.</p>
        </div>
    </div>

    <script>
        // 기존 변수 선언 부분은 동일 (생략하지 않고 그대로 유지)
        const datePicker = document.getElementById('date-picker');
        const typeSelect = document.getElementById('type-select');
        const faceInput = document.getElementById('face-input');
        const img = document.getElementById('newspaper-img');
        const leftImg = document.getElementById('left-img');
        const rightImg = document.getElementById('right-img');
        const errorMsg = document.getElementById('error-msg');
        const pageInfo = document.getElementById('page-info');
        const goBtn = document.getElementById('go-btn');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const singleView = document.getElementById('single-view');
        const doubleView = document.getElementById('double-view');
        const singleModeBtn = document.getElementById('single-mode-btn');
        const doubleModeBtn = document.getElementById('double-mode-btn');

        let viewMode = 'single';

        function generateUrl(dateStr, ftype, face) {
            if (!dateStr) return null;
            const date = dateStr.replace(/-/g, '');
            return `https://plusimg.hankyung.com/apps/image.load?date=${date}&ftype=${ftype}&sz=myun2400&face=${face}&bridge=N`;
        }

        function getCurrentFace() {
            let input = faceInput.value.toUpperCase().trim();
            if (!input) input = 'A001';
            const section = input[0] || 'A';
            const numPart = input.slice(1).replace(/\D/g, '') || '1';
            const pageNum = parseInt(numPart);
            return section + String(pageNum).padStart(3, '0');
        }

        function updateImage() {
            const dateVal = datePicker.value;
            if (!dateVal) return;

            let currentFace = getCurrentFace();
            faceInput.value = currentFace;

            if (viewMode === 'double') {
                const pageNum = parseInt(currentFace.slice(1));
                if (pageNum % 2 === 0) {
                    const newPageNum = pageNum - 1;
                    currentFace = currentFace[0] + String(newPageNum).padStart(3, '0');
                    faceInput.value = currentFace;
                }
            }

            const ftype = typeSelect.value;

            if (viewMode === 'single') {
                singleView.style.display = 'block';
                doubleView.style.display = 'none';
                const url = generateUrl(dateVal, ftype, currentFace);
                img.src = url;
                pageInfo.textContent = `${dateVal.replace(/-/g, '.')} | ${typeSelect.options[typeSelect.selectedIndex].text} ${currentFace}면`;
            } else {
                singleView.style.display = 'none';
                doubleView.style.display = 'block';

                const pageNum = parseInt(currentFace.slice(1));
                const rightFace = currentFace;
                const leftFace = currentFace[0] + String(pageNum + 1).padStart(3, '0');

                const rightUrl = generateUrl(dateVal, ftype, rightFace);
                const leftUrl = generateUrl(dateVal, ftype, leftFace);

                rightImg.src = rightUrl;
                leftImg.src = leftUrl;
                pageInfo.textContent = `${dateVal.replace(/-/g, '.')} | ${typeSelect.options[typeSelect.selectedIndex].text} ${rightFace}–${leftFace}면 (두 쪽 보기)`;
            }

            errorMsg.style.display = 'none';
        }

        // 이벤트 리스너 (날짜/타입 변경 시 1면 이동 등) — 기존과 동일
        datePicker.addEventListener('change', () => {
            faceInput.value = typeSelect.value + '001';
            updateImage();
        });
        typeSelect.addEventListener('change', () => {
            faceInput.value = typeSelect.value + '001';
            updateImage();
        });
        goBtn.addEventListener('click', updateImage);
        faceInput.addEventListener('input', updateImage);
        faceInput.addEventListener('keydown', e => { if (e.key === 'Enter') updateImage(); });

        prevBtn.addEventListener('click', () => {
            let currentFace = getCurrentFace();
            let section = currentFace[0];
            let pageNum = parseInt(currentFace.slice(1));
            let step = viewMode === 'double' ? 2 : 1;
            if (pageNum > 1) {
                pageNum -= step;
                faceInput.value = section + String(pageNum).padStart(3, '0');
                updateImage();
            }
        });

        nextBtn.addEventListener('click', () => {
            let currentFace = getCurrentFace();
            let section = currentFace[0];
            let pageNum = parseInt(currentFace.slice(1));
            let step = viewMode === 'double' ? 2 : 1;
            pageNum += step;
            faceInput.value = section + String(pageNum).padStart(3, '0');
            updateImage();
        });

        singleModeBtn.addEventListener('click', () => {
            viewMode = 'single';
            singleModeBtn.classList.add('btn-primary'); singleModeBtn.classList.remove('btn-outline-primary');
            doubleModeBtn.classList.remove('btn-primary'); doubleModeBtn.classList.add('btn-outline-primary');
            updateImage();
        });

        doubleModeBtn.addEventListener('click', () => {
            viewMode = 'double';
            doubleModeBtn.classList.add('btn-primary'); doubleModeBtn.classList.remove('btn-outline-primary');
            singleModeBtn.classList.remove('btn-primary'); singleModeBtn.classList.add('btn-outline-primary');
            updateImage();
        });

        // 에러 처리 (기존과 동일)
        img.onerror = () => handleImageError();
        rightImg.onerror = () => handleImageError();
        leftImg.onerror = () => { leftImg.src = ''; };

        function handleImageError() {
            const currentFace = getCurrentFace();
            const pageNum = parseInt(currentFace.slice(1));

            if (pageNum === 1 && typeSelect.value === 'A') {
                const currentDate = new Date(datePicker.value);
                currentDate.setDate(currentDate.getDate() - 1);
                const yyyy = currentDate.getFullYear();
                const mm = String(currentDate.getMonth() + 1).padStart(2, '0');
                const dd = String(currentDate.getDate()).padStart(2, '0');
                const newDateStr = `${yyyy}-${mm}-${dd}`;

                const today = new Date();
                const maxBackDate = new Date(today);
                maxBackDate.setDate(today.getDate() - 7);
                if (currentDate < maxBackDate) {
                    alert("최근 7일 내에 신문이 존재하지 않습니다.");
                    errorMsg.style.display = 'block';
                    img.src = ''; leftImg.src = ''; rightImg.src = '';
                    return;
                }

                datePicker.value = newDateStr;
                alert(`해당 날짜 신문이 없습니다. 전날 신문으로 이동합니다: ${newDateStr.replace(/-/g, '.')}`);
                faceInput.value = 'A001';
                updateImage();
                return;
            }

            if (pageNum === 1 && typeSelect.value !== 'A') {
                alert("해당 타입의 신문이 존재하지 않습니다.\nA타입(종합)으로 전환합니다.");
                typeSelect.value = 'A';
                faceInput.value = 'A001';
                updateImage();
                return;
            }

            alert("해당 페이지가 존재하지 않습니다.");
            if (pageNum > 1) {
                let step = viewMode === 'double' ? 2 : 1;
                const newPageNum = pageNum - step;
                faceInput.value = currentFace[0] + String(newPageNum).padStart(3, '0');
                updateImage();
            } else {
                errorMsg.style.display = 'block';
                img.src = ''; leftImg.src = ''; rightImg.src = '';
            }
        }

        img.onload = leftImg.onload = rightImg.onload = () => { errorMsg.style.display = 'none'; };

        // ===== 핵심: 페이지 넘김 영역 클릭/터치 이벤트 (20% 영역만) =====
        document.querySelectorAll('.click-left, .click-right').forEach(area => {
            area.addEventListener('touchstart', e => {
                // pinch-zoom 중에는 무시 (두 손가락 이상)
                if (e.touches.length >= 2) return;
                e.preventDefault();
                if (area.classList.contains('click-left')) {
                    prevBtn.click();
                } else {
                    nextBtn.click();
                }
            }, { passive: false });

            area.addEventListener('click', e => {
                e.preventDefault();
                if (area.classList.contains('click-left')) {
                    prevBtn.click();
                } else {
                    nextBtn.click();
                }
            });
        });

        // 긴 누름으로 컨트롤 토글 (기존 그대로)
        let longPressTimer = null;
        const LONG_PRESS_DURATION = 600;

        function toggleControls() {
            const controls = document.querySelector('.controls');
            controls.classList.toggle('visible');
            if (navigator.vibrate) navigator.vibrate(50);
        }

        function startLongPress() {
            cancelLongPress();
            longPressTimer = setTimeout(toggleControls, LONG_PRESS_DURATION);
        }

        function cancelLongPress() {
            if (longPressTimer) clearTimeout(longPressTimer);
            longPressTimer = null;
        }

        document.body.addEventListener('mousedown', e => { 
            if (e.button === 0 && !e.target.classList.contains('click-left') && !e.target.classList.contains('click-right')) startLongPress(); 
        });
        document.body.addEventListener('mouseup', cancelLongPress);
        document.body.addEventListener('mouseleave', cancelLongPress);
        document.body.addEventListener('mousemove', cancelLongPress);

        document.body.addEventListener('touchstart', e => { 
            if (!e.target.classList.contains('click-left') && !e.target.classList.contains('click-right')) startLongPress(); 
        }, { passive: false });
        document.body.addEventListener('touchend', cancelLongPress);
        document.body.addEventListener('touchcancel', cancelLongPress);
        document.body.addEventListener('touchmove', cancelLongPress, { passive: false });

        // 초기 설정
        const today = new Date;
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        datePicker.value = `${yyyy}-${mm}-${dd}`;

        typeSelect.value = 'A';
        faceInput.value = 'A001';

        updateImage();
    </script>
</body>

</html>
